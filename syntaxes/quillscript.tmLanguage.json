{
	"$schema": "https://raw.githubusercontent.com/martinring/tmlanguage/master/tmlanguage.json",
	"name": "Quillscript Language",
	"scopeName": "source.qsc",

	"patterns": [
		{ "include": "#dialogue"  },
		{ "include": "#option"    },
		{ "include": "#label"     },
		{ "include": "#router"      },
		{ "include": "#command"   },
		{ "include": "#condition" },
		{ "include": "#directive" },
		{ "include": "#comment"   },
		{ "include": "#text"      }
	],

	"repository": {
		"dialogue": {
			"match": "^\\t*(\\-\\ )(.*?)(?=\\||$)(.*$)",

			"captures": {
				"1": { "name": "entity.name.type.class.dialogue.sign.qsc" },

				"2": {
					"name": "entity.name.type.class.dialogue.main.qsc",

					"patterns": [
						{ "include": "#variable" },

						{ "include": "#definition" },

						{ "include": "#richtext" }
					]
				},

				"3": { "patterns": [ { "include": "#metadata" } ] }
			}
		},

		"option": {
			"match": "^\\t*(\\*\\ )(.*?)(?=\\||$)(.*$)",

			"captures": {
				"1": { "name": "entity.name.type.enum.option.sign.qsc" },

				"2": {
					"name": "entity.name.type.enum.option.main.qsc",
					"patterns": [
						{ "include": "#variable" },

						{ "include": "#definition" },

						{ "include": "#richtext" }
					]
				},

				"3": { "patterns": [ { "include": "#metadata" } ] }
			}
		},

		"label": {
			"match": "^\\t*(@\\ )(.*?)(?=\\ \\||$)(.*$)",

			"captures": {
				"1": { "name": "entity.name.namespace.label.sign.qsc" },

				"2": { "patterns": [ { "include": "#label_instruction" } ] },

				"3": { "patterns": [ { "include": "#metadata" } ] }
			}
		},

		"router": {
			"match": "^\\t*([\\<]?\\-\\>\\ )(.*?)(?=\\||$)(.*$)",

			"captures": {
				"1": { "name": "keyword.control.router.sign.qsc" },

				"2": { "patterns": [ { "include": "#router_instruction" } ] },

				"3": { "patterns": [ { "include": "#metadata" } ] }
			}
		},

		"command": {
			"match": "^\\t*(\\$\\ )(.*?)(?=\\||$)(.*$)",

			"captures": {
				"1": { "name": "entity.name.function.command.sign.qsc" },

				"2": { "patterns": [ { "include": "#command_instruction" } ] },

				"3": { "patterns": [ { "include": "#metadata" } ] }
			}
		},

		"condition": {
			"match": "^\\t*(\\?\\ if|\\?\\ elseif|\\?\\ else|\\?\\ endif|if|elseif|else|endif)([\\:]?)(.*?)(?=\\||$)(.*$)",

			"captures": {
				"1": { "name": "keyword.operator.condition.qsc" },

				"2": { "name": "keyword.operator.qsc" },

				"3": { "patterns": [ { "include": "#condition_instruction" } ] },

				"4": {
					"patterns": [
						{
							"match": "(\\|)(.*?)(?=(\\||$))",

							"captures": {
								"1": { "name": "keyword.operator.concat.qsc" },

								"2": {
									"patterns": [
										{
											"match": "(\\@.[^\\s].*)|(\\?.[^\\s].*)|(\\$.[^\\s].*)|(->.[^\\s].*)|(\\#.[^\\s].*)|(\\w+.*)",

											"captures": {
												"1": { "patterns": [ { "include": "#label_instruction" } ] },

												"2": { "patterns": [ { "include": "#condition_instruction" } ] },

												"3": { "patterns": [ { "include": "#command_instruction" } ] },

												"4": { "patterns": [ { "include": "#router_instruction" } ] },

												"5": { "patterns": [ { "include": "#tag" } ] },

												"6": { "patterns": [ { "include": "#condition_instruction" } ] }
											}
										},

										{ "include": "#definition" }
									]
								}
							}
						}
					]
				}
			}
		},

		"directive": {
			"match": "^\\t*(\\~\\ )(\\w+)(.*$)",

			"captures": {
				"1": { "name": "entity.name.other.preprocessor.macro.directive.sign.qsc" },

				"2": { "name": "entity.name.other.preprocessor.macro.directive.main.qsc" },

				"3": { "name": "entity.name.other.preprocessor.macro.directive.param.qsc" }
			}
		},

		"comment": {
			"patterns": [
				{
					"name": "comment.title.qsc",
					"match": "(SCENE|ACT|CHAPTER|SCRIPT)[ -Z]+"
				},

				{
					"match": "^\\t*(//\\ )(.*$)",
					"captures": {
						"1": { "name": "comment.sign.qsc" },

						"2": {
							"name": "comment.qsc",
							"patterns": [
								{
									"name": "comment.topic.qsc",
									"match": "<>"
								}
							]
						}
					}
				}
			]
		},

		"text": {
			"name": "string.qsc",
			"match": "^.*",

			"captures": {
				"0": {
					"patterns": [
						{ "include": "#richtext" },

						{ "include": "#variable" },

						{ "include": "#definition" },

						{
							"name": "keyword.operator.condition.qsc",
							"match": "\\-\\-\\-"
						}
					]
				}
			}
		},

		"metadata": {
			"match": "(\\|)(.*?)(?=(\\||$))",

			"captures": {
				"1": { "name": "keyword.operator.concat.qsc" },

				"2": {
					"patterns": [
						{ "include": "#instruction" },

						{ "include": "#definition" }
					]
				}
			}
		},

		"instruction" : {
			"match": "(\\@.[^\\s].*)|(\\?.[^\\s].*)|(\\$.[^\\s].*)|([\\<]?\\-\\>\\ .[^\\s].*)|(\\#.[^\\s].*)|(\\w+.*)",

			"captures": {
				"1": { "patterns": [ { "include": "#label_instruction" } ] },

				"2": { "patterns": [ { "include": "#condition_instruction" } ] },

				"3": { "patterns": [ { "include": "#command_instruction" } ] },

				"4": { "patterns": [ { "include": "#router_instruction" } ] },

				"5": { "patterns": [ { "include": "#tag" } ] },

				"6": { "patterns": [ { "include": "#command_instruction" } ] }
			}
		},

		"label_instruction": {
			"patterns": [
				{
					"name": "entity.name.namespace.label.sign.qsc",
					"match": "\\@"
				},

				{
					"match": "([^\\s]+)(.*)",

					"captures": {
						"1": { "name": "entity.name.namespace.label.main.qsc" },

						"2": {
							"name": "entity.name.namespace.label.param.qsc",

							"patterns": [
								{
									"name": "entity.name.namespace.label.template.qsc",
									"match": "(\\()|(\\))|(\\,)"
								},

								{ "include": "#definition" }
							]
						}
					}
				}
			]
		},

		"router_instruction": {
			"patterns": [
				{
					"name": "keyword.control.router.sign.qsc",
					"match": "[\\<]?\\-\\>\\ "
				},

				{
					"match": "([^\\s]+)(.*)",

					"captures": {
						"1": { "name": "keyword.control.router.main.qsc" },

						"2": {
							"name": "entity.name.namespace.label.param.qsc",

							"patterns": [
								{
									"name": "entity.name.namespace.label.template.qsc",
									"match": "(\\()|(\\))|(\\,)"
								},

								{ "include": "#variable" },

								{ "include": "#definition" }
							]
						}
					}
				}
			]
		},

		"command_instruction": {
			"patterns": [
				{
					"name": "entity.name.function.command.sign.qsc",
					"match": "\\$"
				},

				{
					"name": "entity.name.function.command.sign.qsc",
					"match": "\\&|\\^|\\%"
				},

				{
					"match": "([^\\s]+)(.*)",

					"captures": {
						"1": {
							"name": "entity.name.function.command.main.qsc"
						},

						"2": {
							"name": "string.qsc",

							"patterns": [
								{ "include": "#richtext" },

								{ "include": "#operator" },

								{ "include": "#parentheses" },

								{ "include": "#number" },

								{ "include": "#keyword" },

								{ "include": "#variable" },

								{ "include": "#definition" }
							]
						}
					}
				}
			]
		},

		"condition_instruction": {
			"patterns": [
				{
					"name": "keyword.operator.condition.qsc",
					"match": "\\?"
				},

				{ "include": "#richtext" },

				{ "include": "#operator" },

				{ "include": "#parentheses" },

				{ "include": "#number" },

				{ "include": "#keyword" },

				{ "include": "#variable" },

				{ "include": "#definition" },

				{
					"name": "string.qsc",
					"match": "\\w+"
				}
			]
		},

		"tag": {
			"patterns": [
				{
					"name": "variable.other.constant.tag.qsc",
					"match": "\\#"
				},

				{
					"name": "variable.other.constant.qsc",
					"match": "\\w+"
				}
			]
		},

		"variable": {
			"name": "variable.other.property.qsc",
			"match": "{[^\\s]+}"
		},

		"definition": {
			"name": "entity.name.other.preprocessor.macro.directive.param.qsc",
			"match": "\\[\\[[^\\s]+\\]\\]"
		},

		"richtext": {
			"name": "entity.name.tag.qsc",
			"match": "<(\\w*).*?>"
		},

		"operator": {
			"name": "keyword.operator.qsc",
			"match": "=|\\band\\b|\\bAND\\b|\\bor\\b|\\bOR\\b|==|!=|>=|<=|(?<!-)>|<|\\+|-(?!>)|\\*|\/|\\%|\\^"
		},

		"parentheses": {
			"name": "keyword.operator.parentheses.qsc",
			"match": "\\(|\\)"
		},

		"keyword": {
			"name": "constant.language.qsc",
			"match": "\\btrue\\b|\\bfalse\\b|\\bon\\b|\\boff\\b|\\bnull\\b|\\bnullptr\\b"
		},

		"number": {
			"name": "constant.number.qsc",
			"match": "(?<!\\w)([\\d]+)(?!\\w)"
		}
	}
}
